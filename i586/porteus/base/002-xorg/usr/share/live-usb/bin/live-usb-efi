#!/bin/bash

ISO=$1
USB=$2
FPT=$3
SPT=$4

#==== create USB partitions ====#
format1_usb()
{
dd if=/dev/zero of=$USB bs=512 count=1
gdisk $USB << EOF
o
y
o
y
n
1


ef00
w
y
EOF

# Format partition 1
mkdosfs ${USB}1
}

format2_usb()
{
if [ "${SPT:0:3}" = "fat" ]
then
	FS=0700
else
	FS=8300
fi
 
dd if=/dev/zero of=$USB bs=512 count=1
gdisk $USB << EOF
o
y
o
y
n
1

+${FPT}M
ef00
n
2


${FS}
w
y
EOF

# Format partition 1
mkdosfs ${USB}1

# Format partition 2
case $SPT in
ext4)
	mkfs.ext4 -F ${USB}2
	;;
ext3)
	mkfs.ext3 -F ${USB}2
	;;
*)
	mkdosfs ${USB}2
	;;
esac
}

target_base=${USB##*/}
for a in /dev/${target_base}[0-9];
do
	umount $a 2>/dev/null;
done

if [ "${FPT:0:3}" = "max" ]
then
	format1_usb
else
	format2_usb
fi

#==== set USB 1st partition ====#
[ ! -d /mnt/${target_base}1 ] && mkdir /mnt/${target_base}1
mount ${USB}1 /mnt/${target_base}1

mkdir -p /tmp/live-usb/iso
mount -o loop $ISO /tmp/live-usb/iso
cp -rv /tmp/live-usb/iso/* /mnt/${target_base}1/.

#if [ ! -d /mnt/${target_base}1/EFI ]
#then
#rm -fr /mnt/${target_base}1/EFI
#	cp -rv /usr/share/live-usb/EFI /mnt/${target_base}1/.
#	cp -rv /usr/share/live-usb/dot.disk /mnt/${target_base}1/.disk
#else
#	if [ -d /tmp/live-usb/iso/.disk ]
#	then
#		cp -rv /tmp/live-usb/iso/.disk /mnt/${target_base}1/.
#	fi
#fi

umount /tmp/live-usb/iso
rm -fr /tmp/live-usb/iso

umount ${USB}1 2>/dev/null

#==== set USB 2nd partition ====#

#==== SYNC ====#
sync
