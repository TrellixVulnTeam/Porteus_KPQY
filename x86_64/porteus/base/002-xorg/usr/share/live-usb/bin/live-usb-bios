#!/bin/bash

ISO=$1
USB=$2
FPT=$3
SPT=$4

#==== create USB partitions ====#
format1_usb()
{
fdisk $USB << EOF
o
n
p
1


t
c
a
1
w
EOF

# Set MBR (boot code)#
cat /usr/share/live-usb/lib/mbr.bin > ${USB}

# Format partition 1
mkdosfs ${USB}1
}

format2_usb()
{
if [ "${SPT:0:3}" = "fat" ]
then
	FS=c
else
	FS=83
fi

fdisk $USB << EOF
o
n
p
1

+${FPT}M
t
c
n
p
2


t
2
${FS}
a
1
w
EOF

# Set MBR (boot code)#
cat /usr/share/live-usb/lib/mbr.bin > ${USB}

# Format partition 1
mkdosfs ${USB}1

# Format partition 2
case $SPT in
ext4)
	mkfs.ext4 -F ${USB}2
	;;
ext3)
	mkfs.ext3 -F ${USB}2
	;;
*)
	mkdosfs ${USB}2
	;;
esac
}

target_base=${USB##*/}
for a in /dev/${target_base}[0-9];
do
	umount $a 2>/dev/null;
done
if [ "${FPT:0:3}" = "max" ]
then
	format1_usb
else
	format2_usb
fi

#==== set USB 1st partition ====#
[ ! -d /mnt/${target_base}1 ] && mkdir /mnt/${target_base}1
mount ${USB}1 /mnt/${target_base}1

mkdir -p /tmp/live-usb/iso
mount -o loop $ISO /tmp/live-usb/iso
cp -rv /tmp/live-usb/iso/* /mnt/${target_base}1/.
umount /tmp/live-usb/iso
rm -fr /tmp/live-usb/iso

umount ${USB}1 2>/dev/null

if [ `uname -m` != x86_64 ];
then
	/usr/share/live-usb/bin/syslinux32 -f -d /boot/syslinux ${USB}1
else
	/usr/share/live-usb/bin/syslinux64 -f -d /boot/syslinux ${USB}1
fi

#==== set USB 2nd partition ====#

#==== SYNC ====#
sync
